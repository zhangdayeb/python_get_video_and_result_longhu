================================================================================
                        龙虎监控系统 - 架构文档
================================================================================


一、操作界面
--------------------------------------------------------------------------------
    - 统计信息展示
    - 日志输出
    - 截图预览
    - 操作按钮


================================================================================
二、监听架构
================================================================================

三大监听模块: 浏览器监控(URL+SessionStorage) + HTTP收发监听 + DOM监听


2.0 基础信息 (从URL获取)
--------------------------------------------------------------------------------
    table_id    :  URL参数 desk=1 即台桌ID
    gameType    :  7 = 龙虎 (对应线上类型2)


2.1 HTTP响应监控
--------------------------------------------------------------------------------
    靴号(xue)   :  从 httpapi.aspx 响应获取


2.2 DOM监控
--------------------------------------------------------------------------------
    投注状态    :  .status
    倒计时      :  .timer, .m-timer
    牌型DOM     :  .d-card-result-root (需hex解码)


2.3 HTTP请求监控
--------------------------------------------------------------------------------
    FLV信号     :  监控 .flv 请求
    开牌信号    :  监控 httpapi.aspx 响应


2.4 浏览器监控
--------------------------------------------------------------------------------
    session信息 :  从 sessionStorage 获取凭证 (ply004, USER_NAME)
    用途        :  补全用户数据，用于请求 roadmap 数据


2.5 信号推导
--------------------------------------------------------------------------------
    开局信号    :  从倒计时+投注状态变化推导
    结束信号    :  从倒计时+投注状态变化推导


2.6 铺号
--------------------------------------------------------------------------------
    来源        :  从 roadmap 响应中获取当前铺数，之后每局递增
    注意        :  不能从DOM获取，DOM显示的"局号"无实际用途


2.7 开牌牌型
--------------------------------------------------------------------------------
    result + result_pai :  从截图通过AI识别获取


================================================================================
三、数据来源汇总
================================================================================

    +------------+------------+----------------------------------+
    | 数据项     | 来源       | 说明                             |
    +------------+------------+----------------------------------+
    | table_id   | URL        | desk=1                           |
    | gameType   | URL        | 7 -> 线上2 (龙虎)                |
    | 靴号(xue)  | HTTP响应   | httpapi.aspx 返回                |
    | 铺号       | HTTP响应   | roadmap数据统计后递增            |
    | 投注状态   | DOM        | .status                          |
    | 倒计时     | DOM        | .timer, .m-timer                 |
    | 牌型       | DOM + AI   | .d-card-result-root + 截图识别   |
    | FLV地址    | HTTP请求   | .flv 请求URL                     |
    | session    | 浏览器     | sessionStorage                   |
    | 开局/结束  | DOM        | 倒计时+投注状态变化推导          |
    +------------+------------+----------------------------------+


================================================================================
四、实现状态
================================================================================

    +------+-------------------------------+------+-----------------------+
    | 模块 | 说明                          | 状态 | 代码位置              |
    +------+-------------------------------+------+-----------------------+
    | 2.0  | table_id, gameType 从URL获取  |  OK  | _check_browser_state()|
    | 2.1  | 靴号从HTTP响应获取            |  OK  | _parse_response()     |
    | 2.2  | 投注状态从DOM获取             |  OK  | .status               |
    | 2.2  | 倒计时从DOM获取               |  OK  | .timer, .m-timer      |
    | 2.2  | 牌型DOM获取                   |  OK  | .d-card-result-root   |
    | 2.3  | HTTP监控FLV信号               |  OK  | 检测 .flv 请求        |
    | 2.3  | HTTP监控开牌信号              |  OK  | httpapi.aspx 响应     |
    | 2.4  | session信息获取               |  OK  | _capture_storage()    |
    | 2.5  | 开局/结束信号                 |  OK  | 倒计时+状态变化回调   |
    | 2.6  | 铺号从roadmap获取             |  OK  | len(results)+1        |
    | 2.7  | 牌型信息AI识别                |  OK  | src/ai/recognizer.py  |
    +------+-------------------------------+------+-----------------------+


================================================================================
五、日志存储
================================================================================
    - 临时数据保存到 logs/ 目录
    - 保留时间: 20分钟 (可配置)
    - 超时数据自动清理


================================================================================
六、截图识别
================================================================================
    - 截图保存到 screenshots/ 目录
    - AI识别牌型 (龙虎只有2张牌)
    - 结果存入数据库


================================================================================
七、信号发送
================================================================================
    - 监听DOM变化触发信号
    - 开局信号: 投注状态变为"开始接受投注"
    - 结束信号: 投注状态变为"停止投注"
    - 开牌信号: 牌型DOM可见时触发


================================================================================
八、关键信息转换
================================================================================

    +------------+---------------------------------------------+
    | 转换类型   | 说明                                        |
    +------------+---------------------------------------------+
    | 台桌对应   | desk=1 -> F1, desk=2 -> F2                  |
    | 游戏类型   | 7->2(龙虎)                                  |
    | 扑克编码   | v_408C -> value=4, suit=s(黑桃)             |
    | 花色映射   | 0=黑桃, 1=红桃, 2=梅花, 3=方块              |
    +------------+---------------------------------------------+


================================================================================
九、龙虎特殊规则
================================================================================

9.1 牌面数量
    - 龙虎只有2张牌: 龙牌(index=1) + 虎牌(index=2)
    - 无补牌规则

9.2 比大小规则
    K(13) > Q(12) > J(11) > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2 > A(1)
    - 龙牌 > 虎牌: 龙赢 (result=1)
    - 虎牌 > 龙牌: 虎赢 (result=2)
    - 相等: 和局 (result=3)

9.3 结果编码
    - 马总格式: result|ext (ext固定为0，龙虎无对子)
    - 1|0 = 龙赢
    - 2|0 = 虎赢
    - 3|0 = 和局


================================================================================
十、关键业务对比
================================================================================

1 台桌状态监控
2 flv 获取更新
3 路单获取更新
4 线上铺数量跟接口对比实现路单更新
5 截图大小图 (龙虎只有2张牌)
6 AI 识别 (龙虎只有2张牌)
7 start 信号
7 post_data 数据格式 信号
8 end 信号 结束信号 换靴信号 这些

================================================================================
